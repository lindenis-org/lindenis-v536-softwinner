jjjjuuu/*************************************************
Copyright (C), 2015, AllwinnerTech. Co., Ltd.
File name: media_file_manager.h
Author: yinzh@allwinnertech.com
Version: 0.1
Date: 2015-10-30
Description:
    1.é–«æ°³ç¹ƒç’‹å†ªæ•¤éç‰ˆåµæ´æ’´å¸´é™£(DBCtrl)éºãƒ¥å½›ç€¹ç‚µå¹‡éç‰ˆåµç€›æ¨ºå
    2.ç» ï¼„æ‚Šæ¾¶æ°¬çŸæµ£æ’´æƒæµ è®¹ç´é–å‘®å«­é”›å±¾æƒæµ è·ºæ‚•é¨å‹­æ•“é´æ„¶ç´é‚å›¦æ¬¢é”çŠºĞ’é–¿
    3.ç€¹ç‚µå¹‡é·å¶‡åéœå±½ç¶éå¿“ç•¬é´æ„®æ®‘é¥ç‚¶çšŸæ¾¶å‹­æ‚Š
History:
*************************************************/
#ifndef _MEDIA_FILE_MANAGER_H
#define _MEDIA_FILE_MANAGER_H

#include "common/subject.h"
#include "common/observer.h"
#include "common/message.h"
#include "common/common_inc.h"
#include "common/singleton.h"

#include <SQLiteCpp/SQLiteCpp.h>

#include <string>
#include <vector>

#include <thread>
#include <mutex>

namespace SQLite
{
    class Database;
}

namespace EyeseeLinux {

typedef struct MixFileInfo
{
	std::string file_name;
	long long time_value;
	std::string typeStr;
	std::string infoStr;
	long long sizeValue;
	long long LockValue;
	long long LockTimeValue;
	long long CheckStateValue;
	std::string KeyStr;
	std::string orderNumStr;
}MixFileInfo_;

class MediaFile;
class MediaFileManager
    : public IObserverWrap(MediaFileManager)
    , public Singleton<MediaFileManager>
    , public ISubjectWrap(MediaFileManager)
{
    friend class Singleton<MediaFileManager>;
    public:
        MediaFileManager();
        ~MediaFileManager();
        MediaFileManager(const MediaFileManager &o);
        MediaFileManager &operator=(const MediaFileManager &o);

        int8_t AddFile(const MediaFile &file, int p_CamId = 0, std::string keyValue = "12345");
        int8_t AddFile(const MediaFile &file, SQLite::Statement &stm, int count=-1, int p_CamId = 0, std::string keyValue = "12345",std::string order_Num = "");
        int8_t RemoveFile(const std::string &filename);
        int8_t GetMediaFileList(std::vector<std::string> &file_list,uint32_t idx_s, uint16_t list_cnt, bool order, const std::string &media_type,int p_CamId = 0);
        uint32_t GetMediaFileCnt(const std::string &media_type, int p_CamId = 0);
        int8_t DeleteFileByName(const std::string &file_name, int p_CamId = 0);
        int8_t DeleteLastFile(const std::string &media_type, int cnt, int p_CamId = 0, bool m_force=false);
        const std::string GetMediaFileType(const std::string &file_name, int p_CamId = 0);
        time_t GetFileTimestampByName(const std::string &file_name, int p_CamId = 0);
        void Update(MSG_TYPE msg, int p_CamID=0, int p_recordId=0);
        std::string GetThumbPicName(const std::string &file_name);
        std::string GetThumbVideoName(const std::string &file_name);

		/*
		*åç§°: bool IsFileExist(char *p_FileName)
		*åŠŸèƒ½: åˆ¤æ–­æŒ‡å®šçš„æ–‡ä»¶åœ¨æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨
		*å‚æ•°: 
		*	p_FileName: éœ€è¦æŸ¥æ‰¾çš„æ–‡ä»¶åç§°
		*      p_CamId:éœ€è¦æŸ¥æ‰¾çš„å“ªä¸ªæ•°æ®åº“
		*è¿”å›å€¼:
		*	true:æˆåŠŸ
		*	false:å¤±è´¥
		*ä¿®æ”¹: åˆ›å»º2018/5/17
		*/
		bool IsFileExist(const std::string &p_FileName,int p_CamId);

		/*
		*åç§°: int  SetFileLockStatus(const std::string &p_FileName, int p_LockStatus,int p_CamId)
		*åŠŸèƒ½: è®¾ç½®æ•°æ®åº“ä¸­æ–‡ä»¶çš„é”å®šçŠ¶æ€å€¼
		*å‚æ•°: 
		*	p_FileName: éœ€è¦æŸ¥æ‰¾çš„æ–‡ä»¶åç§°
		*   p_LockStatus: é”å®šå€¼
		*      p_CamId:éœ€è¦æŸ¥æ‰¾çš„å“ªä¸ªæ•°æ®åº“
		*è¿”å›å€¼:
		*	0:æˆåŠŸ
		*	-1:å¤±è´¥
		*ä¿®æ”¹: åˆ›å»º2018/5/17
		*/
		int  SetFileLockStatus(const std::string &p_FileName, int p_LockStatus,int p_CamId);
		/*
		*åç§°: int  GetFileLockStatus(const std::string &p_FileName, int p_LockStatus,int p_CamId)
		*åŠŸèƒ½: è®¾ç½®æ•°æ®åº“ä¸­æ–‡ä»¶çš„é”å®šçŠ¶æ€å€¼
		*å‚æ•°: 
		*	p_FileName: éœ€è¦æŸ¥æ‰¾çš„æ–‡ä»¶åç§°
		*   p_LockStatus: é”å®šå€¼
		*      p_CamId:éœ€è¦æŸ¥æ‰¾çš„å“ªä¸ªæ•°æ®åº“
		*è¿”å›å€¼:
		*	0:æˆåŠŸ
		*	-1:å¤±è´¥
		*ä¿®æ”¹: åˆ›å»º2018/5/17
		*/
		int  GetFileLockStatus(const std::string &p_FileName, int *p_LockStatus,int p_CamId);
		/*
		*åç§°: int GetFileList(string p_startTime, string p_stopTime, std::vector<std::string> &p_FileNameList,int p_CamId)
		*åŠŸèƒ½: è·å–æŒ‡å®šæ—¶é—´æ®µå†…çš„æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯
		*å‚æ•°: 
		*	p_startTime: å¼€å§‹æ—¶é—´
		*   p_stopTime: ç»“æŸæ—¶é—´
		*   p_FileNameList: æŸ¥è¯¢ç»“æœå­˜å‚¨å®¹å™¨
		*      p_CamId:éœ€è¦æŸ¥æ‰¾çš„å“ªä¸ªæ•°æ®åº“
		*è¿”å›å€¼:
		*	0:æˆåŠŸ
		*	-1:å¤±è´¥
		*ä¿®æ”¹: åˆ›å»º2018/5/17
		*/
		int GetFileList(const std::string p_startTime, const std::string p_stopTime, std::vector<std::string> &p_FileNameList,int p_CamId, std::string p_OrderId);

		/*
		*åç§°: int setFileLockTime(const std::string p_FileName, const std::string p_LockTime, int p_CamId, int p_action)
		*åŠŸèƒ½: è®¾ç½®æŒ‡å®šæ–‡ä»¶çš„é”å®šæ—¶é—´
		*å‚æ•°: 
		*	p_FileName: æ–‡ä»¶å
		*   p_LockTime: é”å®šæ—¶é—´
		*   p_CamId:éœ€è¦æŸ¥æ‰¾çš„å“ªä¸ªæ•°æ®åº“
		*   p_action: 0(è®¾ç½®é”å®š)/1(è®¾ç½®è§£é”)
		*è¿”å›å€¼:
		*	0:æˆåŠŸ
		*	-1:å¤±è´¥
		*ä¿®æ”¹: åˆ›å»º2018/5/17
		*/
		int setFileLockTime(const std::string p_FileName, const std::string p_LockTime, int p_CamId, int p_action);
		/*
		*åç§°: int getFileLockInfo(std::map<std::string, std::string> &p_Info, int p_CamId)
		*åŠŸèƒ½: è·å–æ•°æ®åº“ä¸­çš„é”å®šæ–‡ä»¶ä¿¡æ¯,åŒ…æ‹¬æ–‡ä»¶åä¸é”å®šæ—¶é—´
		*å‚æ•°: 
		*	p_Info: æ–‡ä»¶ä¿¡æ¯
		*   p_CamId:  æ‘„åƒå¤´ID 0:å‰ç½® 1:åç½®
		*è¿”å›å€¼:
		*	0:æˆåŠŸ
		*	-1:å¤±è´¥
		*ä¿®æ”¹: åˆ›å»º2018/5/24
		*/
		int getFileLockInfo(std::map<std::string, std::string> &p_Info, int p_CamId);

		/*
		*åç§°: int getLockFileCount(int p_CamId)
		*åŠŸèƒ½: è·å–æ•°æ®åº“ä¸­çš„é”å®šæ–‡ä»¶ä¸ªæ•°
		*å‚æ•°: 
		*   p_CamId:  æ‘„åƒå¤´ID 0:å‰ç½® 1:åç½®
		*è¿”å›å€¼:
		*	æ–‡ä»¶ä¸ªæ•°
		*ä¿®æ”¹: åˆ›å»º2018/5/24
		*/
		int getLockFileCount(int p_CamId);
		/*
		*åç§°: int GetFileKey(const string &p_FileName,string &keystring)
		*åŠŸèƒ½: æ ¹æ®p_FileName å’Œp_CamId è·å–å¯¹åº”æ•°æ®åº“å¯¹åº”çš„keystring
		*å‚æ•°: 
		*  
		*è¿”å›å€¼:
		*	æˆåŠŸï¼š0  å¤±è´¥-1
		*ä¿®æ”¹: åˆ›å»º2018/06/05
		*/
		int GetFileKey(const std::string &p_FileName, std::string &keystring);

		/*
		*åç§°: int GetFileList(std::map<std::string, std::string> &file_list, int p_CamId)
		*åŠŸèƒ½: è·å–p_CamIdå¯¹åº”æ•°æ®åº“æ–‡ä»¶ä¿¡æ¯
		*å‚æ•°: 
		*  file_list: æ–‡ä»¶ä¿¡æ¯
		*è¿”å›å€¼:
		*	0: æˆåŠŸ  
		*   -1: å¤±è´¥
		*ä¿®æ”¹: åˆ›å»º2018/06/05
		*/
		int GetFileList(std::map<std::string, std::string> &file_list, int p_CamId) ;
		/*
		*åç§°: int GetAllInfoFileList(std::vector<MixFileInfo_>&file_list, int p_CamId)
		*åŠŸèƒ½: è·å–p_CamIdå¯¹åº”æ•°æ®åº“æ–‡ä»¶ä¿¡æ¯
		*å‚æ•°: 
		*  file_list:æ•°æ®åº“æ–‡ä»¶æ‰€æœ‰ä¿¡æ¯
		*è¿”å›å€¼:
		*	0: æˆåŠŸ  
		*   -1: å¤±è´¥
		*ä¿®æ”¹: åˆ›å»º2018/06/05
		*/
		int GetAllInfoFileList(std::vector<MixFileInfo_>&file_list, int p_CamId);

		/*
		*åç§°: int setRollingOrder(const string p_OrderId, int p_Status)
		*åŠŸèƒ½: è®¾ç½®é¡ºé£è½¦æŒ‡ä»¤
		*å‚æ•°:	
		*	p_OrderId: é¡ºé£è½¦è®¢å•å· è¾“å…¥
		*	p_Status: è®¢å•ç»“æŸ(0)/è®¢å•å¼€å§‹(1)
		*è¿”å›å€¼:
		*	0:æˆåŠŸ
		*	1:å¤±è´¥
		*ä¿®æ”¹: åˆ›å»º2018/6/30
		*/
		int setOrderId(const std::string p_OrderId,int p_Status);
		
		/*
		*åç§°: int getRollingOrderId(string &p_OrderId)
		*åŠŸèƒ½: è·å–é¡ºé£è½¦è®¢å•å·
		*å‚æ•°:	
		*	p_OrderId: é¡ºé£è½¦è®¢å•å· è¾“å‡º
		*è¿”å›å€¼:
		*	0:æˆåŠŸ
		*	1:å¤±è´¥
		*ä¿®æ”¹: åˆ›å»º2018/6/30
		*/
		int getOrderId(std::string &p_OrderId);

		/*
		*åç§°: bool DataBaseIsAlready()
		*åŠŸèƒ½: è·å–æ•°æ®åº“æ˜¯å¦åˆ›å»ºå’Œåˆ·æ–°å®Œæˆ
		*å‚æ•°:	
		*è¿”å›å€¼:
		*	true:å¯ä»¥è¯»å–
		*	false:æœªå‡†å¤‡å¥½
		*ä¿®æ”¹: åˆ›å»º2018/6/30
		*/
		bool DataBaseIsAlready();
		int  startCreateDataBase();
	private:
		static void DBInitThread(MediaFileManager *self);
		static void DoDBUpdate(MediaFileManager *self);
        int8_t DBUpdate();
        int8_t DeleteFilesByType(const std::string &media_type, int p_CamId = 0);

		/*
		*åç§°: bool getNewDbCreateFlag(int p_CamId)
		*åŠŸèƒ½: æ ¹æ®p_CamId è·å–å¯¹åº”çš„æ•°æ®åº“æ˜¯å¦åˆ›å»ºæ ‡å¿—ä½
		*å‚æ•°: 
		*   p_CamId:  æ‘„åƒå¤´ID 0:å‰ç½® 1:åç½®
		*è¿”å›å€¼:
		*	æ•°æ®åº“çš„åˆ›å»ºæ ‡å¿—ä½
		*ä¿®æ”¹: åˆ›å»º2018/06/05
		*/
		bool getNewDbCreateFlag(int P_CamID);

		/*
		*åç§°: int8_t clearCheckFlag(int p_CamId)
		*åŠŸèƒ½: æ ¹æ®p_CamId å¯¹åº”æ•°æ®åº“è®¾ç½®å¯¹åº”çš„checkstate = 0
		*å‚æ•°: 
		*   p_CamId:  æ‘„åƒå¤´ID 0:å‰ç½® 1:åç½®
		*è¿”å›å€¼:
		*	æˆåŠŸï¼š0  å¤±è´¥-1
		*ä¿®æ”¹: åˆ›å»º2018/06/05
		*/

		int8_t clearCheckFlag(int p_CamId);
		/*
		*åç§°: int8_t setCheckFlag(int P_CamID,int checkF,const std::string & file_name);
		*åŠŸèƒ½: æ ¹æ®p_CamId å¯¹åº”æ•°æ®åº“è®¾ç½®å¯¹åº”çš„checkstate çš„å€¼
		*å‚æ•°: 
		*   p_CamId:  æ‘„åƒå¤´ID 0:å‰ç½® 1:åç½®
		*è¿”å›å€¼:
		*	æˆåŠŸï¼š0  å¤±è´¥-1
		*ä¿®æ”¹: åˆ›å»º2018/06/05
		*/
		int8_t setCheckFlag(int P_CamID,int checkF,const std::string & file_name);

		/*
		*åç§°: SQLite::Database * getDBHandle(int p_CamId)
		*åŠŸèƒ½: æ ¹æ®p_CamId è·å–å¯¹åº”çš„æ•°æ®åº“å¥æŸ„
		*å‚æ•°: 
		*   p_CamId:  æ‘„åƒå¤´ID 0:å‰ç½® 1:åç½®
		*è¿”å›å€¼:
		*	æ•°æ®åº“çš„å¥æŸ„
		*ä¿®æ”¹: åˆ›å»º2018/06/05
		*/

		SQLite::Database * getDBHandle(int P_CamID){ return P_CamID==0?db_:m_BackCam_db;}
		/*
		*åç§°: void DoDBUpdateByCamId(MediaFileManager *self,int P_CamID)
		*åŠŸèƒ½: æ ¹æ®p_CamId æ›´æ–°å¯¹åº”çš„æ•°æ®åº“è®°å½•å†…å®¹
		*å‚æ•°: 
		*   self:  MediaFileManager ç±»æŒ‡é’ˆ
		*   p_CamId:  æ‘„åƒå¤´ID 0:å‰ç½® 1:åç½®
		*ä¿®æ”¹: åˆ›å»º2018/06/05
		*/

		void DoDBUpdateByCamId(MediaFileManager *self,int P_CamID);
		/*
		*åç§°: int8_t deleteFileFromDB(int p_CamId)
		*åŠŸèƒ½: æ ¹æ®p_CamId åˆ é™¤å¯¹åº”æ•°æ®åº“é‡Œé¢checkstatus =0 çš„ä¸å­˜åœ¨çš„æ–‡ä»¶è®°å½•ä¿¡æ¯
		*å‚æ•°: 
		*   p_CamId:  æ‘„åƒå¤´ID 0:å‰ç½® 1:åç½®
		*è¿”å›å€¼:
		*	æˆåŠŸï¼š0  å¤±è´¥-1
		*ä¿®æ”¹: åˆ›å»º2018/06/05
		*/
		int8_t deleteFileFromDB(int p_CamId);

		/*
		*åç§°: int getFileCount(int p_CamId)
		*åŠŸèƒ½: è·å–æ•°æ®åº“ä¸­çš„å¯¹åº”Id æ–‡ä»¶ä¸ªæ•°
		*å‚æ•°: 
		*   p_CamId:  æ‘„åƒå¤´ID 0:å‰ç½® 1:åç½®
		*è¿”å›å€¼:
		*	æ–‡ä»¶ä¸ªæ•°
		*ä¿®æ”¹: åˆ›å»º2018/06/04
		*/
		int getFileCount(int p_CamId);

        int8_t DBInit();
        int8_t DBReset();
        int8_t DeleteFileByOrder(const std::string &media_type, bool order, int p_CamId = 0,bool m_force=false);
		void timeString2Time_t(const std::string &timestr,time_t *time);
		int InsertLockInfoToMap(std::map<std::string, std::string> &p_Info,const std::string &file_name,const std::string &LockTime);

    private:
		pthread_mutex_t m_lock, m_db_lock;
        bool db_inited_; //è®°å½•dbæ•°æ®åº“æ˜¯å¦åˆ›å»ºå®Œæˆ
        bool db_stop_update_; //è®°å½•æ•°æ®åº“æ–‡ä»¶æ‰«ææ˜¯å¦å®Œæˆ
        bool db_update_done_;
		bool db_new_create_;
		bool db_backCam_new_create_;
        std::thread db_update_thread_, m_DbInit_thread;
        SQLite::Database *db_;
	 	SQLite::Database *m_BackCam_db;
		std::string m_orderId;
		int m_OrderStatus;
}; // class MediaManager
} // namespace EyeseeLinux

#endif // media_file_manager.h
