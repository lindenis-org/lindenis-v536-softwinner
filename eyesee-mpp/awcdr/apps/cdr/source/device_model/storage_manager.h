/* *******************************************************************************
 * Copyright (C), 2001-2016, Allwinner Tech. Co., Ltd.
 * *******************************************************************************/
/**
 * @file storage_manager.h
 * @brief Â≠òÂÇ®ÁÆ°ÁêÜÁ±ªÂ§¥Êñá‰ª∂
 *
 *  - Êñá‰ª∂ÂèäÊï∞ÊçÆÂ∫ìÁÆ°ÁêÜ
 *  - Á£ÅÁõòÁÆ°ÁêÜÔºåÁ£ÅÁõòÁöÑÁä∂ÊÄÅÁª¥Êä§ÔºåÁ£ÅÁõòÂÖ±‰∫´ÔºåÊ†ºÂºèÂåñÁ≠â
 *
 * @author id:826
 * @version v0.3
 * @date 2015-11-02
 * @verbatim
    History:
    - 2016-06-07, change for v40 ipc demo
   @endverbatim
 */
#pragma once

#include "common/message.h"
#include "common/subject.h"
#include "common/singleton.h"
#include "common/common_inc.h"

#include <list>
#include <thread>

namespace EyeseeLinux {

#define UDEV_HANDLER   "/usr/bin/udev_handler"
#define CHECK_FS_BIN1   "/usr/bin/fsck_msdos"
#define CHECK_FS_BIN2   "/sbin/fsck.fat"
/** usage: newfs_msdos -F 32 -O allwinner -b 65536 -c 128 */
#define FORMAT_BIN     "/usr/bin/newfs_msdos"

#define MOUNT_PATH     "/mnt/extsd"
#define VERSION_DIR    "version"
#define VERSION_DIR_NET ".tmp/.net_version"
#define VERSION_4G_DIR_NET ".tmp/.net_4g_version"

#ifdef USE_CAMB
#define VIDEO_DIR_A    "video/F"
#define VIDEO_DIR_B    "video/R"
#define PHOTO_DIR_A    "photo/F"
#define PHOTO_DIR_B    "photo/R"
#define EVENT_DIR_A    "event/F"
#define EVENT_DIR_B    "event/R"
#define PARK_DIR_A     "park/F"
#define PARK_DIR_B     "park/R"
#else
#define VIDEO_DIR_A    "video"
#define VIDEO_DIR_B    "video"
#define PHOTO_DIR_A    "photo"
#define PHOTO_DIR_B    "photo"
#define EVENT_DIR_A    "event"
#define EVENT_DIR_B    "event"
#define PARK_DIR_A     "event"
#define PARK_DIR_B     "event"

#endif



#define TMP_DIR        ".tmp"
#define LOG_DIR        ".tmp/.log"
#define LOG_BIN        ".tmp/.log_bin"
#define TRAFFICG_DIR_GPS		".tmp/.log/gps"

#define DD_SERV_LOG				".tmp/.log"
// Á≤æÂΩ©Áû¨Èó¥Êñá‰ª∂ÁõÆÂΩï
// #define WON_DIR     "wonderful"

#define RESERVED_SIZE 100

// NOTE: ÂøÖÈ°ªÂ§ß‰∫éÊúÄÂ§ßÈ¢ÑÂàÜÈÖçÊñá‰ª∂Â§ßÂ∞è
#define LOOP_COVERAGE_SIZE 1152
#define STORAGE_RESERVE_SIZE 800*1024
#define FRONT_REC_RESERVE_SIZE 3*1024*1024
#define WARN_RESERVE_SIZE 1*1024*1024

#define VIDEO_RESERVE_SIZE 800*1024  //300M*3*2
#define SOS_VIDEO_RESERVE_SIZE 900*1024 //150M*3*2
#define PARK_RESERVE_SIZE 300*1024  //300M*3*2
#define PHOTO_A_RESERVE_SIZE 300*1024
#define PHOTO_B_RESERVE_SIZE 300*1024



/** Á£ÅÁõòÁä∂ÊÄÅ */
enum STORAGE_STATUS {
    MOUNTED = 0x00,
    UMOUNT = 0x01,
    FORMATTING = 0x02,
    STORAGE_FS_ERROR = 0x03,
    STORAGE_DISK_FULL = 0x4,
    STORAGE_LOOP_COVERAGE = 0x5,
};

typedef enum STORAGE_CAPACITY_STATUS{
	CAPACITY_ENOUGH = 0,
	CAPACITY_WARN,
	CAPACITY_EMERGENCY,
	CAPACITY_ERROR,
}CapacityStatus;
enum STORAGE_SPEED_STATUS{
	HIGH_SPEED = 0,
	LOW_SPEED,
	ERROR_SPEED,
};

class EventManager;

/** Â≠òÂÇ®ÁÆ°ÁêÜÁ±ª */
class StorageManager
    : public Singleton<StorageManager>
    , public ISubjectWrap(StorageManager)
    , public AsyncObserverWrap(StorageManager)
{
    friend class Singleton<StorageManager>;
    public:
        StorageManager();
        ~StorageManager();
        StorageManager &operator=(const StorageManager &o);

		/*
		*????: void Init()
		*????: ?????ƒº?ƒø¬º?·ππ??????sd????????sd??◊¥Ã¨÷µ
		*????:
		*????÷µ:
		*?ﬁ∏?: ????2018/7/5
		*/
        void Init();

		/*
		*????: int GetStorageStatus()
		*????: ??»°sd??◊¥Ã¨÷µ
		*????:
		*????÷µ:
		*?ﬁ∏?: ????2018/7/5
		*/
        int GetStorageStatus();

		/*
		*????: int FreeSpace()
		*????: ?Õ∑≈ø’º‰£¨??…æ?????œµ?????
		*????:
		*????÷µ:
		*?ﬁ∏?: ????2018/7/5
		*/
        int FreeSpace();

		/*
		*????: int Format()
		*????: ?? Ω?????Ãø’º‰£¨ƒ¨?œ∏? ΩŒ™fat32
		*????:
		*????÷µ:
		*   ?…π?: 0
		*    ß??: -1
		*?ﬁ∏?: ????2018/7/5
		*/
        int Format();

		/*
		*????: void GetStorageCapacity(uint32_t *as, uint32_t *ts)
		*????: ??»°sd???????? £????
		*????:
		* 	as:??????
		*   ts:????
		*????÷µ:
		*?ﬁ∏?: ????2018/7/5
		*/
        void GetStorageCapacity(uint32_t *as, uint32_t *ts);

		/*
		*????: int32_t GetFileSize(const char *file_name)
		*????: ??»°÷∏???ƒº????ƒº???–°
		*????:
		* 	file_name:?ƒº?????
		*????÷µ:
		*   ?ƒº???–°
		*?ﬁ∏?: ????2018/7/5
		*/
        int32_t GetFileSize(const char *file_name);

		/*
		*????: int32_t GetFileSize(const char *file_name)
		*????: …æ??÷∏???ƒº?
		*????:
		* 	file_name:?ƒº?????
		*????÷µ:
		*   ?…π?: 0
		*    ß??: -1
		*?ﬁ∏?: ????2018/7/5
		*/
        int RemoveFile(const char *file_name);

		/*
		*????: int RemoveFiles(const char *path)
		*????: …æ??÷∏??ƒø¬º?¬µ??ƒº?
		*????:
		* 	path:ƒø¬º????
		*????÷µ:
		*   ?…π?: 0
		*    ß??: -1
		*?ﬁ∏?: ????2018/7/5
		*/
        int RemoveFiles(const char *path);

        void Update(MSG_TYPE msg, int p_CamID=0, int p_recordId=0);

		/*
		*????: int  readCpuInfo(char *info)
		*????: ??»°cpu??œ¢
		*????:
		* 	info:  cpu??œ¢
		*????÷µ:
		*   ?…π?: 0
		*    ß??: -1
		*?ﬁ∏?: ????2018/7/5
		*/
		int  readCpuInfo(char *info);

		/*
		*????: bool CheckStorageIsOk()
		*????: ?–∂?sd???«∑????‘Ω??–¥Ê¥¢????????Œ¥???ÿ£????ﬂø????Ì∂º?????????–¥Ê¥¢
		*????:
		*????÷µ:
		*   ???‘¥Ê¥¢: true
		*   ???‹¥Ê¥¢: false
		*?ﬁ∏?: ????2018/7/5
		*/
        bool CheckStorageIsOk();

		/*
		*????: CapacityStatus getBackCameraCapacityStatus()
		*????: ??»°????????Õ∑?Ê¥¢?’º?◊¥Ã¨
		*????:
		*????÷µ:
		*      ?Ê¥¢?’º?◊¥Ã¨???–ø’º‰£¨???ﬂø’º‰ø™ º???≈£??????ﬁø’º‰£¨ ???ﬂ≥???
		*?ﬁ∏?: ????2018/7/5
		*/
		CapacityStatus getBackCameraCapacityStatus();

		/*
		*????: bool IsFrontCameraFull()
		*????: ?–∂?«∞??????Õ∑?’º??«∑???
		*????:
		*????÷µ:
		*   ??: true
		*   Œ¥??: false
		*?ﬁ∏?: ????2018/7/5
		*/
		bool IsFrontCameraFull();

		/*
		*name: int GetStorageThreshold(uint32_t threshold, uint32_t *percent)
		*description: get tf card used percent, if above the threshold return 0
		*parameter: threshold: the threshold to report,eg 90; 
        *           percent:   the report percent value
		*/
        int GetStorageThreshold(uint32_t threshold, uint32_t *percent);

		/*
		*????: uint32_t getLockFileCapacity()
		*????: ??»°????????Õ∑?????ƒº??–±???–°
		*????:
		*????÷µ:
		*   ?????ƒº?’º?√ø’º???–°÷µ
		*?ﬁ∏?: ????2018/7/5
		*/
		uint32_t getLockFileCapacity();
		int setLockFileCapacity(int32_t p_value);

		/*
		*????: int SetFormat()
		*????: ??Ã®???Õ∏? Ω??sd??????
		*????:
		*????÷µ:
		*   ?…π?: 0
		*    ß??: -1
		*?ﬁ∏?: ????2018/7/5
		*/
		int SetFormat();

		/*
		*????: bool IsHighClassCard()
		*????: ?–∂œ≤????ƒø??«∑??«∏??Ÿø?
		*????:
		*????÷µ:
		*   ?…π?: true
		*    ß??: false
		*?ﬁ∏?: ????2018/7/14
		*/
		int IsHighClassCard();

		int my_system(const char *cmd);
        bool IsMounted();

		/*
		*????: uint32_t getDirSize(const std::string p_DirName)
		*????: ??»°÷∏??ƒø¬º?ƒø’º?’º??????
		*????:
		*????÷µ:
		*   ?’º?’º??÷µ????ŒªKB
		*?ﬁ∏?: ????2018/7/5
		*/
		uint32_t getDirSize(const std::string p_DirName);

		int ForceUmount();
		/*
		*????: bool CheckFileSystemError()
		*????: ?ﬁ∏?sd??
		*????:
		*????÷µ:
		*   ?…π?: true
		*    ß??: false
		*?ﬁ∏?: ????2018/7/5
		*/
		bool CheckFileSystemError();
		void setFormatFlag(bool val){m_format_flag = val;}
		bool getFormatFlag(){return m_format_flag;}
		void setMOccupyDir(bool flag){m_occupy_dir = flag;}
		void setMReadOnlyDiskFormatFinish(bool flag){m_ReadOnlyDiskFormatFinish = flag;}
		bool getUmountFlag(){return m_umount_flag;}
        bool CheckVideoRecordFDirFull();
        bool CheckVideoRecordRDirFull();
        bool CheckParkRecordDirFull();        
        bool CheckPhotoBDirFull();
        bool CheckPhotoADirFull();
        int MountToPC();
        int UMountFromPC();
        uint32_t getvideoFDirReserveSize();
        uint32_t getvideoRDirReserveSize();
        uint32_t getvideoParkDirReserveSize();
private:
		/*
		*????: int CreateAllDirectory()
		*????: ?????ƒº?ƒø¬º?·ππ
		*????:
		*????÷µ:
		*   ?…π?: 0
		*    ß??: 1
		*?ﬁ∏?: ????2018/7/5
		*/
		int CreateAllDirectory();

		/*
		*????: int DirectFormat()
		*????: ?? Ω?? µ?÷∫?????
		*????:
		*????÷µ:
		*?ﬁ∏?: ????2018/7/5
		*/
        int DirectFormat();

 		/*
		*????: int Mount(const char *mount_point, const char *dev_node)
		*????: ????sd????÷∏??ƒø¬º
		*????:
		*   mount_point: ????ƒø¬º
		*   dev_node: sd???Ë±∏?⁄µ?
		*????÷µ:
		*   ?…π?: 0
		*    ß??: -1
		*?ﬁ∏?: ????2018/7/5
		*/
		int Mount(const char *mount_point, const char *dev_node);

		/*
		*????: int UMount(const char *mount_point)
		*????: –∂??sd??????ƒø¬º
		*????:
		*   mount_point: ????ƒø¬º
		*????÷µ:
		*   ?…π?: 0
		*    ß??: -1
		*?ﬁ∏?: ????2018/7/5
		*/
		int UMount(const char *mount_point);
#if 0
		/*
		*????: bool IsMounted()
		*????: ?–∂?sd?????«∑??—æ?????
		*????:
		*????÷µ:
		*   ?…π?: true
		*    ß??: false
		*?ﬁ∏?: ????2018/7/5
		*/
        bool IsMounted();
#endif
		/*
		*????: void *EventMsgHandler(void *context)
		*????: ??œ¢◊™???·ππ?Â£¨?‘∫????????⁄µ???œ¢????????◊™??
		*????:
		*????÷µ:
		*?ﬁ∏?: ????2018/7/5
		*/
		static void *EventMsgHandler(void *context);

   		/*
		*????: bool IsSupportSystemType()
		*????: ?–∂?sd???ƒº?œµÕ≥?«∑???÷ß?÷µ?????
		*????:
		*????÷µ:
		*   ÷ß?? true
		*   ??÷ß??: false
		*?ﬁ∏?: ????2018/7/5
		*/
		bool IsSupportSystemType();

		/*
		*????: void CapacityCheckThread(StorageManager *self)
		*????: —≠??¬º???’º??????ﬂ≥Ã£??’º‰≤ª?? ±????????…æ?????œµ??ƒº?????÷§?‹π?????—≠??¬º??
		*????:
		*????÷µ:
		*?ﬁ∏?: ????2018/7/5
		*/
		static void CapacityCheckThread(StorageManager *self);

		/*
		*????: void FormatSdThread(StorageManager *self)
		*????: ?? Ω???ﬂ≥Ã£????⁄¥?????Ã®???Õ∏? Ω??????
		*????:
		*????÷µ:
		*?ﬁ∏?: ????2018/7/5
		*/
		static void FormatSdThread(StorageManager *self);
		/*
		*????: bool DetectTotalCapacitySupported()
		*????: ?–∂?sd?????«∑???÷ß???–±????Ê£¨ƒø«∞÷ª÷ß??32G,64G
		*????:
		*????÷µ:
		*   ÷ß??: true
		*   ??÷ß??: false
		*?ﬁ∏?: ????2018/7/5
		*/
		bool DetectTotalCapacitySupported();

		bool GetFormat();

		static void CheckCardReadOnlyThread(StorageManager *self);

private:
        int m_storageStatus;
        int m_percentReported;
        FILE *m_handlerSD_fp;
        std::string m_storageDevice;
        EventManager *m_EventManager;
        pthread_mutex_t m_lock;
	 	pthread_mutex_t m_Notifylock;	
        std::thread m_cap_check_thread;
        std::thread m_formatThread;
		std::thread m_checkCardReadOnlyThread;

        char m_fileSystemType[10];
		
		bool m_bDiskFullNotifyFlag;
		bool m_bFormatSdExit;
		bool m_bNeedFormat;
		bool mLoopRecordFlag;
		bool m_format_flag;
		bool m_occupy_dir;//mnt/extsd/ has been Occupied
		bool m_ReadOnlyDiskFormatFinish;
		bool m_umount_flag;//
		uint32_t m_LockFileCapacity; //MB
}; // class StorageManager
} // namespace EyeseeLinux
